{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    {% if current_user.user_type != 'admin' %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Lista projekcija</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerProjectionModal">
            <i class="fas fa-plus me-2"></i>Dodaj novu projekciju
        </button>
    </div>
    {% endif %}

    <!-- Filter opcije -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Filteri</h5>
            <form id="filter-form" class="row g-3">
                <div class="col-md-3">
                    <label for="film" class="form-label">Film</label>
                    <select class="form-select" id="film" name="film">
                        <option value="">Svi filmovi</option>
                        {% for movie in movies %}
                            <option value="{{ movie.id }}" {% if request.args.get('film') == movie.id|string %}selected{% endif %}>
                                {{ movie.local_title }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="date_from" class="form-label">Datum od</label>
                    <input type="month" class="form-control" id="date_from" name="date_from" value="{{ request.args.get('date_from', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="date_to" class="form-label">Datum do</label>
                    <input type="month" class="form-control" id="date_to" name="date_to" value="{{ request.args.get('date_to', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="filter_format" class="form-label">Format</label>
                    <select class="form-select" id="filter_format" name="filter_format">
                        <option value="">Svi formati</option>
                        <option value="2D" {% if request.args.get('filter_format') == '2D' %}selected{% endif %}>2D</option>
                        <option value="3D" {% if request.args.get('filter_format') == '3D' %}selected{% endif %}>3D</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="verzija" class="form-label">Verzija</label>
                    <select class="form-select" id="verzija" name="verzija">
                        <option value="">Sve verzije</option>
                        <option value="original" {% if request.args.get('verzija') == 'original' %}selected{% endif %}>Originalno</option>
                        <option value="subtitled" {% if request.args.get('verzija') == 'subtitled' %}selected{% endif %}>Titlovano</option>
                        <option value="dubbed" {% if request.args.get('verzija') == 'dubbed' %}selected{% endif %}>Sinhronizovano</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Filtriraj</button>
                    <a href="{{ url_for('projections.projections_list') }}" class="btn btn-secondary ms-2">Resetuj</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela sa projekcijama -->
    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Datum</th>
                    <th>Vreme</th>
                    <th>Naziv filma</th>
                    <th>Verzija</th>
                    <th>Format</th>
                    <th>Prodato ulaznica</th>
                    <th>Zarada</th>
                    <th>Akcije</th>
                </tr>
            </thead>
            <tbody>
                {% for projection in projections_list %}
                <tr>
                    <td>{{ projection.date }}</td>
                    <td>{{ projection.time }}</td>
                    <td>{{ projection.movie.local_title }}</td>
                    <td>{{ projection.version }}</td>
                    <td>{{ projection.format }}</td>
                    <td>{{ projection.tickets_sold }}</td>
                    <td>{{ projection.revenue }}</td>
                    <td>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#detailsModal" data-projection-id="{{ projection.id }}">
                            Detalji
                        </button>
                        {% if current_user.user_type != 'admin' %}
                        <button type="button" class="btn btn-danger btn-sm delete-projection" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteProjectionModal"
                                data-projection-id="{{ projection.id }}"
                                data-projection-title="{{ projection.movie.local_title }} ({{ projection.date }} {{ projection.time }})">
                            Obriši projekciju
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal za dodavanje novih projekcija -->
    <div class="modal fade" id="registerProjectionModal" tabindex="-1" aria-labelledby="registerProjectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerProjectionModalLabel">Dodaj novu projekciju</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-projection-form" method="POST" action="{{ url_for('projections.add_projection') }}">
                        {{ add_form.hidden_tag() }}
                        {% for field in add_form if field.widget.input_type != 'hidden' %}
                            <div class="mb-3">
                                {{ field.label(class="form-label") }}
                                {{ field(class="form-control") }}
                            </div>
                        {% endfor %}
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zatvori</button>
                            {{ add_form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal za prikaz detalja projekcije -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">Detalji projekcije</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Naziv filma:</strong> <span id="modalMovieTitle"></span></p>
                    <!-- <p><strong>Datum:</strong> <span id="modalDate"></span></p>
                    <p><strong>Vreme:</strong> <span id="modalTime"></span></p>
                    <p><strong>Verzija:</strong> <span id="modalVersion"></span></p>
                    <p><strong>Format:</strong> <span id="modalFormat"></span></p>
                    <p><strong>Broj prodatih ulaznica:</strong> <span id="modalTicketsSold"></span></p>
                    <p><strong>Zarada:</strong> <span id="modalRevenue"></span></p> -->
                    <p><strong>Broj nedelja prikazivanja:</strong> <span id="modalWeeksShowing"></span></p>
                    <p><strong>Ukupan broj prikazivanja:</strong> <span id="modalTotalScreenings"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zatvori</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal za potvrdu brisanja projekcije -->
    <div class="modal fade" id="deleteProjectionModal" tabindex="-1" aria-labelledby="deleteProjectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteProjectionModalLabel">Potvrda brisanja</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Da li ste sigurni da želite da obrišete projekciju <span id="deleteProjectionTitle"></span>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Odustani</button>
                    <a id="confirmDeleteButton" href="#" class="btn btn-danger">Obriši</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dugmad za izvoz podataka -->
    <div class="mt-4">
        <h3>Izvoz podataka</h3>
        <button id="exportFCS" class="btn btn-secondary">Izvoz za Filmski centar Srbije</button>
        <button id="exportSokoj" class="btn btn-secondary">Izvoz za Sokoj</button>
        <button id="exportEuropaCinemas" class="btn btn-secondary">Izvoz za Europa Cinemas</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script id="movies-data" type="application/json">
    {{ movies_data|tojson|safe }}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ... (postojeći kod) ...

        // Upravljanje modalom za brisanje projekcije
        const deleteProjectionModal = document.getElementById('deleteProjectionModal');
        const deleteProjectionTitle = document.getElementById('deleteProjectionTitle');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');

        deleteProjectionModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const projectionId = button.getAttribute('data-projection-id');
            const projectionTitle = button.getAttribute('data-projection-title');

            deleteProjectionTitle.textContent = projectionTitle;
            confirmDeleteButton.href = `/projections/delete_projection/${projectionId}`;
        });

        // ... (ostatak postojećeg koda) ...
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const moviesDataElement = document.getElementById('movies-data');
        const moviesData = JSON.parse(moviesDataElement.textContent);
        console.log('moviesData:', moviesData);
    
        const movieSelect = document.getElementById('movie_id');
        const versionSelect = document.getElementById('version');
        const formatSelect = document.getElementById('format');
        console.log('formatSelect:', formatSelect);
    
        function updateFormOptions() {
            console.log('movieSelect.value:', movieSelect.value);
            const movieId = parseInt(movieSelect.value);
            const movieData = moviesData.find(movie => movie.id === movieId);
    
            if (movieData) {
                console.log('Movie formats:', movieData.projection_formats);
                // Ažuriranje opcija za verziju
                versionSelect.innerHTML = '';
                movieData.versions.forEach(version => {
                    const option = new Option(version, version);
                    versionSelect.add(option);
                });
    
                // Ažuriranje opcija za format
                console.log('formatSelect - pre:', formatSelect.innerHTML);
                formatSelect.innerHTML = '';
                console.log('formatSelect - posle:', formatSelect.innerHTML);
                if (movieData.projection_formats && movieData.projection_formats.length > 0) {
                    movieData.projection_formats.forEach(format => {
                        const option = new Option(format, format);
                        formatSelect.add(option);
                        console.log('dodata opcija: ', option);
                    });
                } else {
                    console.log('No projection formats found for this movie');
                }
            }
        }
    
        if (movieSelect) {
            movieSelect.addEventListener('change', updateFormOptions);
    
            // Inicijalno ažuriranje opcija ako je film već izabran
            if (movieSelect.value) {
                updateFormOptions();
            }
        } else {
            console.log('movieSelect element not found');
        }

        // Dodajemo event listener za dugme "Detalji"
        const detailsButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#detailsModal"]');
        detailsButtons.forEach(button => {
            button.addEventListener('click', function() {
                const projectionId = this.getAttribute('data-projection-id');
                // Ovde treba dodati AJAX poziv za dobijanje detalja projekcije
                // i popunjavanje modalnog prozora sa dobijenim podacima
                // Primer:
                fetch(`/projections/details/${projectionId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('modalMovieTitle').textContent = data.movie_title;
                        // document.getElementById('modalDate').textContent = data.date;
                        // document.getElementById('modalTime').textContent = data.time;
                        // document.getElementById('modalVersion').textContent = data.version;
                        // document.getElementById('modalFormat').textContent = data.format;
                        // document.getElementById('modalTicketsSold').textContent = data.tickets_sold;
                        // document.getElementById('modalRevenue').textContent = data.revenue;
                        document.getElementById('modalWeeksShowing').textContent = data.weeks_showing;
                        document.getElementById('modalTotalScreenings').textContent = data.total_screenings;
                    });
            });
        });

        // Dodajemo event listenere za dugmad za izvoz
        document.getElementById('exportFCS').addEventListener('click', () => exportData('fcs'));
        document.getElementById('exportSokoj').addEventListener('click', () => exportData('sokoj'));
        document.getElementById('exportEuropaCinemas').addEventListener('click', () => exportData('europa_cinemas'));

        function exportData(type) {
            // Implementacija izvoza podataka
            // Ovo treba da bude AJAX poziv koji će pokrenuti generisanje i preuzimanje XML fajla
            console.log(`Izvoz podataka za ${type}`);
        }
    });
</script>
{% endblock %}