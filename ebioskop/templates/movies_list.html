{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Lista filmova</h1>
                {% if current_user.user_type in ['admin', 'distributor'] %}
                <p class="text-muted mb-0">Pregled i upravljanje filmovima u sistemu</p>
                {% else %}
                <p class="text-muted mb-0">Pregled filmova u sistemu</p>
                {% endif %}
            </div>
            <div class="d-flex gap-3 align-items-center">
                {% if current_user.user_type != 'distributor' %}
                <div>
                    <select class="form-select" id="distributors-select">
                        <option value="">Svi distributeri</option>
                        {% for distributor in distributor_list %}
                        <option value="{{ distributor.id }}">{{ distributor.company_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div>
                    <select class="form-select" id="status-select">
                        <option value="">Svi statusi</option>
                        <option value="in_showing">u distribuciji</option>
                        <option value="finished_showing">Završeno prikazivanje</option>
                        <option value="scheduled_showing">Planirano prikazivanje</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary action-btn" id="apply-filters">
                    <i class="fas fa-filter me-2"></i>Primeni filtere
                </button>
                {% if current_user.user_type in ['admin', 'distributor'] %}
                <button type="button" class="btn btn-add btn-primary" data-bs-toggle="modal" data-bs-target="#registerMovieModal">
                    <i class="fas fa-plus me-2"></i>Dodaj novi film
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Movies Table -->
    <div class="cinema-card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="cinema-table table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 100px;" class="ps-4">Poster</th>
                            <th style="width: 15%;">Naziv</th>
                            <th style="width: 15%;">Kreativni tim</th>
                            <th style="width: 12%;">Tehničke info</th>
                            <th style="width: 10%;">Produkcija</th>
                            {% if current_user.user_type != 'distributor' %}
                            <th style="width: 10%;">Distributer</th>
                            {% endif %}
                            <th style="width: 100px;">Start</th>
                            <th style="width: 8%;">Žanr</th>
                            <th style="width: 90px;">Uzrast</th>
                            <th style="width: 90px;">Status</th>
                            <th style="width: 100px;" class="text-end pe-4">Akcije</th>
                        </tr>
                    </thead>
                    <tbody id="movies-list">
                        {% for movie in movies_list %}
                        <tr class="cinema-row">
                            <td class="ps-4">
                                <div class="gallery-image" style="width: 100px; height: 150px;">
                                    {% if movie.poster %}
                                        <img src="{{ movie.poster }}" 
                                             alt="Poster za {{ movie.local_title }}"
                                             class="w-100 h-100 object-fit-cover rounded">
                                    {% else %}
                                        <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                                            <i class="fas fa-film fa-2x"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="cinema-name">{{ movie.local_title }}</span>
                                    <small class="text-muted">{{ movie.original_title }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold">{{ movie.director }}</span>
                                    <small class="text-muted">{{ movie.actors }}</small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold">{{ movie.duration }} min</span>
                                    <small class="text-muted">
                                        Verzije: {{ ', '.join(movie.versions) }}<br>
                                        Format: {{ ', '.join(movie.projection_formats) }}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <span class="fw-semibold">{{ movie.company }}</span>
                                    <small class="text-muted">{{ movie.production_year }}</small>
                                </div>
                            </td>
                            {% if current_user.user_type != 'distributor' %}
                            <td>
                                <div class="d-flex flex-column distributor-data" data-distributor-id="{{ movie.distributor.id }}">
                                    <span class="fw-semibold">{{ movie.distributor.company_name }}</span>
                                    <small class="text-muted">{{ movie.distributor.phone }}</small>
                                </div>
                            </td>
                            {% endif %}
                            <td>{{ movie.release_date.strftime('%d.%m.%Y') if movie.release_date else 'Nije postavljeno' }}</td>
                            <td>{{ ', '.join(movie.genres) if movie.genres else 'Nije postavljeno' }}</td>
                            <td>
                                <span class="legal-form-badge">{{ movie.age_rating }}</span>
                            </td>
                            <td>
                                {% if movie.is_showing_finished %}
                                    <span class="membership-badge badge-secondary status-badge" data-status="finished_showing">Završeno</span>
                                {% else %}
                                    {% if movie.release_date >= today %}
                                        <span class="membership-badge badge-info status-badge" data-status="scheduled_showing">Planirano</span>
                                    {% else %}
                                        <span class="membership-badge badge-success status-badge" data-status="in_showing">u distribuciji</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                <button type="button" 
                                        class="btn action-btn btn-outline-primary btn-sm edit-movie-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target={% if current_user.user_type in ['admin', 'distributor'] %} "#editMovieModal" {% else %} "#detailsModal" {% endif %}
                                        data-movie-id="{{ movie.id }}">
                                    {% if current_user.user_type in ['admin', 'distributor'] %}
                                    <i class="fas fa-edit me-1"></i>Uredi
                                    {% else %}
                                    <i class="fas fa-info-circle me-1"></i>Opširnije
                                    {% endif %}
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if current_user.user_type in ['admin', 'distributor'] %}
    <div class="modal fade" id="registerMovieModal" tabindex="-1" aria-labelledby="registerMovieModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white p-3">
                    <h5 class="modal-title" id="registerMovieModalLabel">
                        <i class="fas fa-film me-2"></i>Dodaj novi film
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="registerMovieForm" enctype="multipart/form-data" method="POST">
                        {{ register_form.csrf_token }}
    
                        <!-- Osnovne informacije -->
                        <div class="cinema-details-card mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Osnovne informacije
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.original_title.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-language text-muted"></i>
                                            </span>
                                            {{ register_form.original_title(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.local_title.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-signature text-muted"></i>
                                            </span>
                                            {{ register_form.local_title(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Kreativni tim -->
                        <div class="cinema-details-card mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-users me-2"></i>Kreativni tim
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.director.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-video text-muted"></i>
                                            </span>
                                            {{ register_form.director(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.actors.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-user-friends text-muted"></i>
                                            </span>
                                            {{ register_form.actors(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Produkcijske informacije -->
                        <div class="cinema-details-card mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-building me-2"></i>Produkcijske informacije
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.production_country.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-globe text-muted"></i>
                                            </span>
                                            {{ register_form.production_country(class="form-select") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.company.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-building text-muted"></i>
                                            </span>
                                            {{ register_form.company(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.production_year.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-calendar text-muted"></i>
                                            </span>
                                            {{ register_form.production_year(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.duration.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-clock text-muted"></i>
                                            </span>
                                            {{ register_form.duration(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Tehničke informacije -->
                        <div class="cinema-details-card mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-cogs me-2"></i>Tehničke informacije
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.versions.label(class="form-label") }}
                                        {{ register_form.versions(class="form-select", multiple="multiple", size="3") }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.projection_formats.label(class="form-label") }}
                                        {{ register_form.projection_formats(class="form-select", multiple="multiple", size="3") }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.age_rating.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-user-shield text-muted"></i>
                                            </span>
                                            {{ register_form.age_rating(class="form-select") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.genres.label(class="form-label") }}
                                        {{ register_form.genres(class="form-select select2-multiple", multiple="multiple", id="genres") }}
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Medijski sadržaj -->
                        <div class="cinema-details-card mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-images me-2"></i>Medijski sadržaj
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-group">
                                        {{ register_form.poster.label(class="form-label") }}
                                        {{ register_form.poster(class="form-control", type="file") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        {{ register_form.image_1.label(class="form-label") }}
                                        {{ register_form.image_1(class="form-control", type="file") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        {{ register_form.image_2.label(class="form-label") }}
                                        {{ register_form.image_2(class="form-control", type="file") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        {{ register_form.image_3.label(class="form-label") }}
                                        {{ register_form.image_3(class="form-control", type="file") }}
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        {{ register_form.trailer_link.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-play text-muted"></i>
                                            </span>
                                            {{ register_form.trailer_link(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Dodatne informacije -->
                        <div class="cinema-details-card mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-info me-2"></i>Dodatne informacije
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-group">
                                        {{ register_form.synopsis.label(class="form-label") }}
                                        {{ register_form.synopsis(class="form-control", rows="3") }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ register_form.release_date.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text bg-light border-0">
                                                <i class="fas fa-calendar-alt text-muted"></i>
                                            </span>
                                            {{ register_form.release_date(class="form-control", type="date") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Submit dugme -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg action-btn" id="submit-new-movie">
                                <i class="fas fa-save me-2"></i>Dodaj film
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

<!-- Modal za uređivanje filma -->
<div class="modal fade" id="editMovieModal" tabindex="-1" aria-labelledby="editMovieModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="editMovieModalLabel">Uredi film</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <img id="edit_current_poster" src="" alt="Trenutni poster" class="img-fluid rounded">
                    </div>
                    <div class="col-md-6">
                        <div id="editImageCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <img id="edit_current_image_1" src="" class="d-block w-100 rounded" alt="Slika 1">
                                </div>
                                <div class="carousel-item">
                                    <img id="edit_current_image_2" src="" class="d-block w-100 rounded" alt="Slika 2">
                                </div>
                                <div class="carousel-item">
                                    <img id="edit_current_image_3" src="" class="d-block w-100 rounded" alt="Slika 3">
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#editImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Prethodna</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#editImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Sledeća</span>
                            </button>
                        </div>
                    </div>
                </div>
                <form id="editMovieForm" method="post" enctype="multipart/form-data">
                    {{ edit_form.csrf_token }}
                    <input type="hidden" id="edit-movie-id" name="movie_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="edit_original_title" class="form-label">Originalni naziv filma</label>
                            {{ edit_form.original_title(class="form-control", id="edit_original_title") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_local_title" class="form-label">Lokalni naziv filma</label>
                            {{ edit_form.local_title(class="form-control", id="edit_local_title") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_director" class="form-label">Režiser</label>
                            {{ edit_form.director(class="form-control", id="edit_director") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_actors" class="form-label">Glumci</label>
                            {{ edit_form.actors(class="form-control", id="edit_actors") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_production_country" class="form-label">Zemlja produkcije</label>
                            {{ edit_form.production_country(class="form-select", id="edit_production_country") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_company" class="form-label">Naziv produkcije (kompanije)</label>
                            {{ edit_form.company(class="form-control", id="edit_company") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_production_year" class="form-label">Godina produkcije</label>
                            {{ edit_form.production_year(class="form-control", id="edit_production_year") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_duration" class="form-label">Trajanje (u minutima)</label>
                            {{ edit_form.duration(class="form-control", id="edit_duration") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_versions" class="form-label">Verzije filma</label>
                            {{ edit_form.versions(class="form-select", multiple="multiple", size="3", id="edit_versions") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_projection_formats" class="form-label">Projekcioni format</label>
                            {{ edit_form.projection_formats(class="form-select", multiple="multiple", size="3", id="edit_projection_formats") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_age_rating" class="form-label">Starosna preporuka</label>
                            {{ edit_form.age_rating(class="form-select", id="edit_age_rating") }}
                        </div>
                        <div class="col-12">
                            <label for="edit_poster" class="form-label">Link do plakata</label>
                            {{ edit_form.poster(class="form-control", id="edit_poster") }}
                        </div>
                        <div class="col-md-4">
                            <label for="edit_image_1" class="form-label">Slika 1 (16:9)</label>
                            {{ edit_form.image_1(class="form-control", id="edit_image_1") }}
                        </div>
                        <div class="col-md-4">
                            <label for="edit_image_2" class="form-label">Slika 2 (16:9)</label>
                            {{ edit_form.image_2(class="form-control", id="edit_image_2") }}
                        </div>
                        <div class="col-md-4">
                            <label for="edit_image_3" class="form-label">Slika 3 (16:9)</label>
                            {{ edit_form.image_3(class="form-control", id="edit_image_3") }}
                        </div>
                        <div class="col-12">
                            <label for="edit_trailer_link" class="form-label">Link ka trejleru</label>
                            {{ edit_form.trailer_link(class="form-control", id="edit_trailer_link") }}
                        </div>
                        <div class="col-12">
                            <label for="edit_synopsis" class="form-label">Sinopsis</label>
                            {{ edit_form.synopsis(class="form-control", rows="3", id="edit_synopsis") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_genres" class="form-label">Žanr</label>
                            {{ edit_form.genres(class="form-select select2-multiple", multiple="multiple", id="edit_genres") }}
                        </div>
                        <div class="col-md-6">
                            <label for="edit_release_date" class="form-label">Datum starta filma</label>
                            {{ edit_form.release_date(class="form-control", type="date", id="edit_release_date") }}
                        </div>
                        <div class="col-md-12">
                            <div class="form-check">
                                {{ edit_form.is_showing_finished(class="form-check-input", id="edit_is_showing_finished") }}
                                <label class="form-check-label" for="edit_is_showing_finished">
                                    Označiti ako je završena distribucija filma
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary" id="submit-edit-movie">
                            <i class="fas fa-save me-2"></i>Sačuvaj izmene
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- detail modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="detailsModalLabel">Detalji filma</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <img id="details_current_poster" src="" alt="Poster filma" class="img-fluid rounded">
                    </div>
                    <div class="col-md-6">
                        <div id="detailsImageCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <img id="details_current_image_1" src="" class="d-block w-100 rounded" alt="Slika 1">
                                </div>
                                <div class="carousel-item">
                                    <img id="details_current_image_2" src="" class="d-block w-100 rounded" alt="Slika 2">
                                </div>
                                <div class="carousel-item">
                                    <img id="details_current_image_3" src="" class="d-block w-100 rounded" alt="Slika 3">
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#detailsImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Prethodna</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#detailsImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Sledeća</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6>Originalni naziv filma</h6>
                        <p id="details_original_title"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Lokalni naziv filma</h6>
                        <p id="details_local_title"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Režiser</h6>
                        <p id="details_director"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Glumci</h6>
                        <p id="details_actors"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Zemlja produkcije</h6>
                        <p id="details_production_country"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Naziv produkcije (kompanije)</h6>
                        <p id="details_company"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Godina produkcije</h6>
                        <p id="details_production_year"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Trajanje (u minutima)</h6>
                        <p id="details_duration"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Verzije filma</h6>
                        <ul id="details_versions"></ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Projekcioni format</h6>
                        <ul id="details_projection_formats"></ul>
                    </div>
                    <div class="col-12">
                        <h6>Link ka trejleru</h6>
                        <p><a id="details_trailer_link" href="" target="_blank">Pogledaj trejler</a></p>
                    </div>
                    <div class="col-12">
                        <h6>Sinopsis</h6>
                        <p id="details_synopsis"></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Žanr</h6>
                        <ul id="details_genres"></ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Datum starta filma</h6>
                        <p id="details_release_date"></p>
                    </div>
                    <div class="col-md-12">
                        <h6>Status</h6>
                        <p id="details_status"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zatvori</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
//////
$(document).ready(function() {
    // Funkcija za filtriranje
    $('#apply-filters').click(function() {
        var distributorId = $('#distributors-select').val();
        var status = $('#status-select').val();
        
        // Sakrijemo sve redove prvo
        $('#movies-list tr').hide();
        
        // Filtriramo redove prema odabranim kriterijumima
        $('#movies-list tr').each(function() {
            var showRow = true;
            
            // Provera distributera
            if(distributorId) {
                var rowDistributorId = $(this).find('.distributor-data').data('distributor-id');
                if(rowDistributorId != distributorId) {
                    showRow = false;
                }
            }
            
            // Provera statusa
            if(status && showRow) {
                var rowStatus = $(this).find('.status-badge').data('status');
                if(rowStatus != status) {
                    showRow = false;
                }
            }
            
            // Prikažemo red ako zadovoljava sve kriterijume
            if(showRow) {
                $(this).show();
            }
        });
    });
    
    // Resetovanje filtera
    $('.form-select').change(function() {
        if($(this).val() === '') {
            // Ako je izabrana opcija "Svi", prikažemo sve redove
            $('#movies-list tr').show();
        }
    });
});
//////

$(document).ready(function() {
    // $('.select2-multiple').select2()
    $('#registerMovieModal').on('shown.bs.modal', function() {
        $('#genres').select2({
            placeholder: "Izaberi žanrove",
            // tags: true,
            dropdownParent: $(this)
        })
    })

    $('#editMovieModal').on('shown.bs.modal', function() {
        $('#edit_genres').select2({
            placeholder: "Izaberi žanrove",
            // tags: true,
            dropdownParent: $(this)
        })
    })

});

$(document).ready(function() {
    // DataTables inicijalizacija
    $('.cinema-table').DataTable({
        order: [[6, 'desc']], // Sortiranje po Start koloni (index 6) od najvećeg ka najmanjem
        columnDefs: [
            { 
                targets: [0, 3, 4, 5, 6, 8, 9, 10], // Kolone koje ne želimo da budu pretražive
                searchable: false 
            },
            {
                targets: 6, // Start kolona
                type: 'date',
                render: function(data, type, row) {
                    // Za sortiranje vraćamo datum u ISO formatu
                    if (type === 'sort') {
                        return data === 'Nije postavljeno' ? '' : moment(data, 'DD.MM.YYYY').format('YYYY-MM-DD');
                    }
                    // Za prikaz vraćamo originalni format
                    return data;
                }
            }
        ],
        language: {
            search: "Pretraga:",
            lengthMenu: "Prikaži _MENU_ zapisa po strani",
            zeroRecords: "Nisu pronađeni odgovarajući zapisi",
            info: "Prikaz _START_ do _END_ od ukupno _TOTAL_ zapisa",
            infoEmpty: "Prikaz 0 do 0 od ukupno 0 zapisa",
            infoFiltered: "(filtrirano od ukupno _MAX_ zapisa)",
            paginate: {
                first: "Prva",
                last: "Poslednja",
                next: "Sledeća",
                previous: "Prethodna"
            }
        }
    });

    // Dodavanje novog filma
    $("#registerMovieForm").submit(function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            url: "{{ url_for('movies.add_movie') }}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();  // Osvežava stranicu da prikaže novi film
                } else {
                    alert("Greška pri dodavanju filma: " + JSON.stringify(response.errors));
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error: " + status + ": " + error);
                alert("Došlo je do greške pri slanju podataka.");
            }
        });
    });

    // Popunjavanje forme za uređivanje
    $(".edit-movie-btn").click(function() {
        var movieId = $(this).data("movie-id");
        $.ajax({
            url: "{{ url_for('movies.edit_movie', movie_id=0) }}".replace('0', movieId),
            type: "GET",
            success: function(response) {
                $("#edit-movie-id").val(response.id);
                $("#edit_original_title").val(response.original_title);
                $("#edit_local_title").val(response.local_title);
                $("#edit_director").val(response.director);
                $("#edit_actors").val(response.actors);
                $("#edit_production_country").val(response.production_country);
                $("#edit_company").val(response.company);
                $("#edit_production_year").val(response.production_year);
                $("#edit_duration").val(response.duration);
                $("#edit_versions").val(response.versions);
                $("#edit_projection_formats").val(response.projection_formats);
                $("#edit_age_rating").val(response.age_rating);
                $("#edit_trailer_link").val(response.trailer_link);
                $("#edit_synopsis").val(response.synopsis);
                $("#edit_genres").val(response.genres);
                $("#edit_release_date").val(response.release_date);
                $("#edit_is_showing_finished").prop('checked', response.is_showing_finished);

                // Prikazivanje trenutnog postera
                if (response.poster) {
                    $("#edit_current_poster").attr("src", response.poster).show();
                } else {
                    $("#edit_current_poster").hide();
                }

                // Prikazivanje trenutnih slika u carousel-u
                for (var i = 0; i < 3; i++) {
                    var imgElement = $("#edit_current_image_" + (i + 1));
                    if (response.images && response.images[i]) {
                        imgElement.attr("src", response.images[i]).closest('.carousel-item').show();
                    } else {
                        imgElement.closest('.carousel-item').hide();
                    }
                }

                // Resetovanje carousel-a
                $('#editImageCarousel').carousel(0);
            }
        });
    });
    // popunjavavanje detail modala
    $(".edit-movie-btn").click(function() {
        var movieId = $(this).data("movie-id");
        $.ajax({
            url: "{{ url_for('movies.edit_movie', movie_id=0) }}".replace('0', movieId),
            type: "GET",
            success: function(response) {
                $("#details_original_title").text(response.original_title);
                $("#details_local_title").text(response.local_title);
                $("#details_director").text(response.director);
                $("#details_actors").text(response.actors);
                $("#details_production_country").text(response.production_country);
                $("#details_company").text(response.company);
                $("#details_production_year").text(response.production_year);
                $("#details_duration").text(response.duration);
                $("#details_trailer_link").attr("href", response.trailer_link);
                $("#details_synopsis").text(response.synopsis);
                $("#details_release_date").text(response.release_date);
                $("#details_status").text(response.status);

                // Popunjavanje lista
                $("#details_versions").empty();
                response.versions.forEach(function(version) {
                    $("#details_versions").append("<li>" + version + "</li>");
                });

                $("#details_projection_formats").empty();
                response.projection_formats.forEach(function(format) {
                    $("#details_projection_formats").append("<li>" + format + "</li>");
                });

                $("#details_genres").empty();
                response.genres.forEach(function(genre) {
                    $("#details_genres").append("<li>" + genre + "</li>");
                });

                // Prikazivanje postera
                if (response.poster) {
                    $("#details_current_poster").attr("src", response.poster).show();
                } else {
                    $("#details_current_poster").hide();
                }

                // Prikazivanje slika u carousel-u
                for (var i = 0; i < 3; i++) {
                    var imgElement = $("#details_current_image_" + (i + 1));
                    if (response.images && response.images[i]) {
                        imgElement.attr("src", response.images[i]).closest('.carousel-item').show();
                    } else {
                        imgElement.closest('.carousel-item').hide();
                    }
                }

                // Resetovanje carousel-a
                $('#detailsImageCarousel').carousel(0);
            }
        });
    });

    // Uređivanje filma
    $("#editMovieForm").submit(function(e) {
        e.preventDefault();
        var movieId = $("#edit-movie-id").val();
        var formData = new FormData(this);

        $.ajax({
            url: "{{ url_for('movies.edit_movie', movie_id=0) }}".replace('0', movieId),
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();  // Osvežava stranicu da prikaže izmene
                } else {
                    var errorMessage = "Greška pri uređivanju filma:";
                    if (response.errors) {
                        for (var field in response.errors) {
                            errorMessage += "\n- " + field + ": " + response.errors[field].join(", ");
                        }
                    } else {
                        errorMessage += " " + response.message;
                    }
                    alert(errorMessage);
                }
            },
            error: function(xhr, status, error) {
                alert("Došlo je do greške pri slanju podataka: " + error);
            }
        });
    });
});
</script>

{% endblock %}